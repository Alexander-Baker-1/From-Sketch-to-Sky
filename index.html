<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Aircraft Generator - Stage 6</title>
    <!-- Load Three.js library from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
        }

        .left-panel {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .right-panel {
            flex: 2;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            color: #555;
            margin-bottom: 6px;
            font-weight: bold;
            font-size: 14px;
        }

        textarea, input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        button:disabled {
            opacity: 0.5;
        }

        /* 3D Viewer styles */
        #viewer {
            width: 100%;
            height: 500px;
            background: #f0f0f0;
            border-radius: 8px;
            position: relative;
        }

        .viewer-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            color: #333;
            z-index: 10;
        }

        #output {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 13px;
        }

        .params-box {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .param-item {
            padding: 3px 0;
            font-family: monospace;
            font-size: 12px;
        }

        .loading { color: #667eea; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <!-- LEFT PANEL: Controls -->
        <div class="left-panel">
            <h1>‚úàÔ∏è AI Aircraft Generator</h1>
            <p class="subtitle">Stage 6: Adding 3D Viewer</p>
            
            <div class="input-group">
                <label>Gemini API Key:</label>
                <input type="text" id="apiKey" placeholder="Paste your API key">
            </div>
            
            <div class="input-group">
                <label>Describe Aircraft Part:</label>
                <textarea id="userInput" placeholder="Example: swept wing with 35 degree sweep"></textarea>
            </div>
            
            <button id="generateBtn">Generate 3D Part</button>
            
            <div id="output">
                <p>3D viewer is ready! Enter a description and generate.</p>
            </div>
        </div>

        <!-- RIGHT PANEL: 3D Viewer -->
        <div class="right-panel">
            <h1>3D Viewer</h1>
            <div id="viewer">
                <div class="viewer-label">üéÆ Click and drag to rotate</div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // STAGE 6: THREE.JS 3D VIEWER SETUP
        // ============================================

        let scene, camera, renderer, currentMesh;

        // Initialize Three.js when page loads
        window.addEventListener('load', initThreeJS);

        function initThreeJS() {
            console.log('Initializing Three.js...');

            // Get the viewer container
            const container = document.getElementById('viewer');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // 1. CREATE SCENE (the 3D world)
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);  // Light gray background

            // 2. CREATE CAMERA (your eyes into the 3D world)
            camera = new THREE.PerspectiveCamera(
                75,                    // Field of view (how wide you can see)
                width / height,        // Aspect ratio
                0.1,                   // Near clipping plane
                1000                   // Far clipping plane
            );
            camera.position.set(5, 5, 10);  // Position camera in 3D space (x, y, z)
            camera.lookAt(0, 0, 0);         // Point camera at origin

            // 3. CREATE RENDERER (draws everything to screen)
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            container.appendChild(renderer.domElement);

            // 4. ADD LIGHTS (so we can see things)
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);  // Soft overall light
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);  // Strong directional light
            directionalLight.position.set(10, 10, 10);
            scene.add(directionalLight);

            // 5. ADD GRID (floor reference)
            const gridHelper = new THREE.GridHelper(20, 20, 0x888888, 0xcccccc);
            scene.add(gridHelper);

            // 6. ADD AXES HELPER (shows X, Y, Z directions)
            const axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);

            // 7. ADD A TEST CUBE (so we see something immediately)
            createTestCube();

            // 8. START ANIMATION LOOP (makes things rotate)
            animate();

            // 9. HANDLE WINDOW RESIZE
            window.addEventListener('resize', onWindowResize);

            console.log('Three.js initialized successfully!');
        }

        // Create a simple test cube
        function createTestCube() {
            const geometry = new THREE.BoxGeometry(2, 2, 2);  // 2x2x2 cube
            const material = new THREE.MeshStandardMaterial({
                color: 0x667eea,      // Purple color
                metalness: 0.3,       // Slightly metallic
                roughness: 0.7        // Not too shiny
            });
            
            currentMesh = new THREE.Mesh(geometry, material);
            scene.add(currentMesh);
        }

        // Animation loop - runs ~60 times per second
        function animate() {
            requestAnimationFrame(animate);  // Call this function again next frame

            // Rotate the current mesh slowly
            if (currentMesh) {
                currentMesh.rotation.y += 0.01;  // Rotate around Y axis
            }

            // Render the scene from camera's perspective
            renderer.render(scene, camera);
        }

        // Handle window resizing
        function onWindowResize() {
            const container = document.getElementById('viewer');
            const width = container.clientWidth;
            const height = container.clientHeight;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        // ============================================
        // GENERATE BUTTON (will connect to AI next stage)
        // ============================================
        document.getElementById('generateBtn').addEventListener('click', async function() {
            const userInput = document.getElementById('userInput').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const output = document.getElementById('output');

            if (!userInput || !apiKey) {
                output.innerHTML = '<p class="error">Please fill in all fields!</p>';
                return;
            }

            output.innerHTML = '<p class="loading">ü§ñ AI is extracting parameters...</p>';

            try {
                // Call AI to get parameters
                const params = await callGeminiAPI(apiKey, userInput);
                
                // Display parameters
                displayParameters(params);
                
                // In next stage, we'll generate 3D shape from params!
                output.innerHTML += '<p style="margin-top:10px;">‚úì Parameters extracted! (3D generation coming in Stage 7)</p>';
                
            } catch (error) {
                output.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        });

        function displayParameters(params) {
            const output = document.getElementById('output');
            let html = '<h4 class="success">‚úì Extracted Parameters:</h4>';
            html += '<div class="params-box">';
            for (const [key, value] of Object.entries(params)) {
                if (value) {
                    html += `<div class="param-item"><strong>${key}:</strong> ${value}</div>`;
                }
            }
            html += '</div>';
            output.innerHTML = html;
        }

        // ============================================
        // GEMINI API CALL
        // ============================================
        async function callGeminiAPI(apiKey, userInput) {
            const prompt = `Extract aircraft part parameters from: "${userInput}"

Return ONLY valid JSON:
{
  "type": "wing/fuselage/stabilizer",
  "span": number or null,
  "length": number or null,
  "diameter": number or null,
  "sweep": number or null,
  "material": "string or null"
}`;

            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                }
            );

            if (!response.ok) {
                throw new Error('API request failed');
            }

            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;
            const jsonMatch = text.match(/\{[\s\S]*\}/);
            
            if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
            } else {
                throw new Error('Could not parse response');
            }
        }
    </script>
</body>
</html>