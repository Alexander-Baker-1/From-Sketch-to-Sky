<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Aircraft Generator - FINAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
        }

        .left-panel {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .right-panel {
            flex: 2;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        h1 { color: #333; margin-bottom: 10px; font-size: 24px; }
        .subtitle { color: #666; margin-bottom: 20px; font-size: 13px; }
        .input-group { margin-bottom: 15px; }
        
        label {
            display: block;
            color: #555;
            margin-bottom: 6px;
            font-weight: bold;
            font-size: 14px;
        }

        textarea, input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
        }

        textarea { min-height: 80px; resize: vertical; }

        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        button:disabled { opacity: 0.5; }

        #viewer {
            width: 100%;
            height: 500px;
            background: #f0f0f0;
            border-radius: 8px;
            position: relative;
        }

        .viewer-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 10;
        }

        #output {
            margin-top: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 13px;
        }

        .params-box {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .param-item {
            padding: 3px 0;
            font-family: monospace;
            font-size: 12px;
        }

        .example-chip {
            display: inline-block;
            background: #e0e0e0;
            padding: 6px 12px;
            border-radius: 15px;
            margin: 5px 5px 5px 0;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid #ccc;
        }

        .example-chip:hover {
            background: #667eea;
            color: white;
        }

        .loading { color: #667eea; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <div class="container">
        <!-- LEFT PANEL -->
        <div class="left-panel">
            <h1>‚úàÔ∏è AI Aircraft Generator</h1>
            <p class="subtitle">Stage 7: Complete AI + 3D Generation!</p>
            
            <div class="input-group">
                <label>Gemini API Key:</label>
                <input type="text" id="apiKey" placeholder="Paste API key">
            </div>
            
            <div class="input-group">
                <label>Describe Aircraft Part:</label>
                <textarea id="userInput" placeholder="Example: swept wing with 35 degree sweep angle"></textarea>
            </div>
            
            <button id="generateBtn">Generate 3D Part</button>
            
            <div style="margin-top: 15px;">
                <label>üí° Examples:</label>
                <div class="example-chip" data-example="swept wing with 35 degree sweep, 12 meter span">Swept Wing</div>
                <div class="example-chip" data-example="delta wing with 45 degree sweep">Delta Wing</div>
                <div class="example-chip" data-example="fuselage 8 meters long, 2 meter diameter">Fuselage</div>
                <div class="example-chip" data-example="vertical stabilizer 4 meters tall">Stabilizer</div>
            </div>
            
            <div id="output">
                <p>Enter a description and generate a 3D aircraft part!</p>
            </div>
        </div>

        <!-- RIGHT PANEL -->
        <div class="right-panel">
            <h1>3D Viewer</h1>
            <div id="viewer">
                <div class="viewer-label">üéÆ Auto-rotating | 3D model will appear here</div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // THREE.JS SETUP
        // ============================================
        let scene, camera, renderer, currentMesh;

        window.addEventListener('load', initThreeJS);

        function initThreeJS() {
            const container = document.getElementById('viewer');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);

            // Camera
            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            camera.position.set(5, 5, 10);
            camera.lookAt(0, 0, 0);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            container.appendChild(renderer.domElement);

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 10);
            scene.add(directionalLight);

            // Grid and axes
            const gridHelper = new THREE.GridHelper(20, 20, 0x888888, 0xcccccc);
            scene.add(gridHelper);
            const axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);

            // Start animation
            animate();

            // Handle resize
            window.addEventListener('resize', onWindowResize);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (currentMesh) {
                currentMesh.rotation.y += 0.005;  // Slow rotation
            }
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            const container = document.getElementById('viewer');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // ============================================
        // GENERATE 3D AIRCRAFT PART
        // ============================================
        function generateAircraftPart(params) {
            // Remove old mesh
            if (currentMesh) {
                scene.remove(currentMesh);
            }

            const partType = params.type.toLowerCase();
            let geometry, material;

            // Choose material color based on type
            const materialColor = params.material && params.material.includes('carbon') ? 0x222222 :
                                 params.material && params.material.includes('titanium') ? 0xcccccc :
                                 params.material && params.material.includes('aluminum') ? 0xaaaaaa :
                                 0x4488ff;

            material = new THREE.MeshStandardMaterial({
                color: materialColor,
                metalness: 0.7,
                roughness: 0.3
            });

            // GENERATE GEOMETRY BASED ON PART TYPE
            
            if (partType.includes('wing')) {
                // CREATE WING
                const span = params.span || 10;
                const chord = params.chord || 2;
                const sweep = (params.sweep || 0) * Math.PI / 180;  // Convert to radians
                
                // Create wing profile (airfoil shape)
                const shape = new THREE.Shape();
                shape.moveTo(0, 0);
                shape.lineTo(chord, 0);
                shape.lineTo(chord * 0.9, chord * 0.1);
                shape.lineTo(chord * 0.1, chord * 0.1);
                shape.closePath();

                // Extrude to create 3D wing
                const extrudeSettings = {
                    steps: 20,
                    depth: span,
                    bevelEnabled: true,
                    bevelThickness: 0.1,
                    bevelSize: 0.1,
                    bevelSegments: 3
                };

                geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
                geometry.rotateZ(sweep);  // Apply sweep angle
                geometry.rotateX(Math.PI / 2);  // Orient correctly
                
            } else if (partType.includes('fuselage')) {
                // CREATE FUSELAGE
                const length = params.length || 8;
                const diameter = params.diameter || 2;
                
                // Cylinder with taper
                geometry = new THREE.CylinderGeometry(
                    diameter/2,        // Top radius
                    diameter/2 * 0.8,  // Bottom radius (tapered)
                    length,            // Height
                    32                 // Segments
                );
                geometry.rotateZ(Math.PI / 2);  // Horizontal orientation
                
            } else if (partType.includes('stabilizer')) {
                // CREATE STABILIZER
                const span = params.span || 4;
                const chord = 1.5;
                
                // Tail stabilizer shape
                const shape = new THREE.Shape();
                shape.moveTo(0, 0);
                shape.lineTo(chord, 0);
                shape.lineTo(chord * 0.8, chord * 0.15);
                shape.lineTo(chord * 0.2, chord * 0.15);
                shape.closePath();

                const extrudeSettings = {
                    steps: 10,
                    depth: span,
                    bevelEnabled: true,
                    bevelThickness: 0.05,
                    bevelSize: 0.05
                };

                geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
                
                // Vertical or horizontal based on description
                if (partType.includes('vertical')) {
                    geometry.rotateX(Math.PI / 2);
                } else {
                    const sweep = (params.sweep || 0) * Math.PI / 180;
                    geometry.rotateZ(sweep);
                    geometry.rotateX(Math.PI / 2);
                }
                
            } else {
                // DEFAULT: Generic component
                geometry = new THREE.BoxGeometry(3, 1, 6);
            }

            // Create mesh and add to scene
            currentMesh = new THREE.Mesh(geometry, material);
            scene.add(currentMesh);

            // Add wireframe
            const wireframe = new THREE.WireframeGeometry(geometry);
            const line = new THREE.LineSegments(wireframe);
            line.material.color.setHex(0x000000);
            line.material.opacity = 0.15;
            line.material.transparent = true;
            currentMesh.add(line);
        }

        // ============================================
        // GENERATE BUTTON
        // ============================================
        document.getElementById('generateBtn').addEventListener('click', async function() {
            const userInput = document.getElementById('userInput').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const output = document.getElementById('output');
            const button = this;

            if (!apiKey || !userInput) {
                output.innerHTML = '<p class="error">Please fill in all fields!</p>';
                return;
            }

            button.disabled = true;
            output.innerHTML = '<p class="loading">ü§ñ AI is analyzing...</p>';

            try {
                // Get parameters from AI
                const params = await callGeminiAPI(apiKey, userInput);
                
                // Display parameters
                displayParameters(params);
                
                // Generate 3D model
                generateAircraftPart(params);
                
                output.innerHTML += '<p class="success" style="margin-top:10px;">‚úì 3D model generated!</p>';
                
            } catch (error) {
                output.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            } finally {
                button.disabled = false;
            }
        });

        // Example chips
        document.querySelectorAll('.example-chip').forEach(chip => {
            chip.addEventListener('click', function() {
                document.getElementById('userInput').value = this.dataset.example;
            });
        });

        // Display extracted parameters
        function displayParameters(params) {
            const output = document.getElementById('output');
            let html = '<h4 class="success">‚úì Extracted Parameters:</h4>';
            html += '<div class="params-box">';
            for (const [key, value] of Object.entries(params)) {
                if (value !== null && value !== undefined) {
                    html += `<div class="param-item"><strong>${key}:</strong> ${value}</div>`;
                }
            }
            html += '</div>';
            output.innerHTML = html;
        }

        // ============================================
        // GEMINI API CALL
        // ============================================
        async function callGeminiAPI(apiKey, userInput) {
            const prompt = `Extract aircraft part parameters from this description and return ONLY valid JSON.

Description: "${userInput}"

Extract:
{
  "type": "wing/fuselage/stabilizer",
  "span": number in meters or null,
  "length": number in meters or null,
  "diameter": number in meters or null,
  "chord": number in meters or 2 (default for wings),
  "sweep": number in degrees or null,
  "material": "carbon/titanium/aluminum or null"
}

Return ONLY JSON, no other text.`;

            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                }
            );

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'API failed');
            }

            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;
            
            // Extract JSON
            const jsonMatch = text.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
            } else {
                throw new Error('Could not parse AI response');
            }
        }
    </script>
</body>
</html>